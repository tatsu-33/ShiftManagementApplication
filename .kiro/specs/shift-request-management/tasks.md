# 実装計画: シフト申請管理システム

## 概要

Pythonを使用して、LINEボットとWeb管理画面を持つシフト申請管理システムを実装します。従業員はLINEからNG日を申請し、管理者はWebインターフェースで申請を管理してシフトを調整します。

## タスク

- [x] 1. プロジェクト構造とコア設定のセットアップ
  - プロジェクトディレクトリ構造を作成
  - 依存関係管理（requirements.txt）
  - 環境変数設定（.env.example）
  - データベース接続設定
  - _要件: 9.1, 9.2, 9.3_

- [x] 2. データモデルとデータベーススキーマの実装
  - [x] 2.1 データモデルクラスを定義（User, Request, Shift, Settings, ReminderLog）
    - SQLAlchemyまたは同等のORMを使用
    - 各モデルにバリデーションを含める
    - _要件: 9.1, 9.2, 9.3_
  
  - [x] 2.2 データモデルのプロパティテストを作成

    - **プロパティ31: データ永続化のラウンドトリップ**
    - **検証: 要件 9.1, 9.2, 9.3**
  
  - [x] 2.3 データベースマイグレーションスクリプトを作成
    - Alembicまたは同等のツールを使用
    - 初期スキーマ作成
    - _要件: 9.1, 9.2, 9.3_

- [ ] 3. 認証サービスの実装
  - [x] 3.1 LINE ID認証機能を実装
    - LINE IDから従業員を取得
    - 新規従業員登録
    - _要件: 8.1, 8.5_
  
  - [x] 3.2 LINE ID認証のプロパティテストを作成

    - **プロパティ29: LINE IDで従業員が識別される**
    - **検証: 要件 8.1**
  
  - [x] 3.3 管理者認証機能を実装
    - セッションベース認証
    - パスワードハッシュ化
    - 権限確認
    - _要件: 8.2, 8.3, 8.4_
  
  - [x] 3.4 管理者認証のユニットテストを作成

    - 未認証アクセスのテスト
    - 権限不足のテスト
    - _要件: 8.2, 8.3, 8.4_

- [x] 4. チェックポイント - 基盤の確認
  - 全てのテストが通ることを確認し、質問があればユーザーに確認する

- [ ] 5. 申請管理サービスの実装
  - [x] 5.1 申請作成機能を実装
    - 日付バリデーション（翌月チェック）
    - 重複チェック
    - 締切日チェック
    - ステータス設定（pending）
    - _要件: 1.3, 1.4, 1.5, 2.5_
  
  - [x] 5.2 申請作成のプロパティテストを作成

    - **プロパティ2: 申請作成時のステータスは保留中**
    - **プロパティ3: 重複申請は拒否される**
    - **プロパティ4: 申請には必須フィールドが記録される**
    - **プロパティ8: 締切日を過ぎた申請は拒否される**
    - **検証: 要件 1.3, 1.4, 1.5, 2.5**
  
  - [x] 5.3 申請取得・フィルタリング機能を実装
    - 従業員別取得
    - ステータス別取得
    - 日付順ソート
    - 検索機能（従業員名、日付）
    - フィルター機能（ステータス、月）
    - _要件: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 4.4, 4.5_
  
  - [x] 5.4 申請取得・フィルタリングのプロパティテストを作成

    - **プロパティ10: 申請一覧は従業員でフィルタされる**
    - **プロパティ11: 申請表示には必須フィールドが含まれる**
    - **プロパティ12: 申請一覧は日付順にソートされる**
    - **プロパティ13: 管理者は全申請を取得できる**
    - **プロパティ15: 保留中の申請が優先表示される**
    - **プロパティ16: 検索条件に一致する申請のみが返される**
    - **プロパティ17: フィルター条件に一致する申請のみが返される**
    - **検証: 要件 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 4.4, 4.5**
  
  - [x] 5.5 申請承認・却下機能を実装
    - ステータス更新（approved/rejected）
    - 処理情報記録（処理日時、処理者）
    - 処理済み申請の変更拒否
    - _要件: 5.1, 5.2, 5.3, 5.5_
  
  - [x] 5.6 申請承認・却下のプロパティテストを作成

    - **プロパティ18: 承認時にステータスが更新される**
    - **プロパティ19: 却下時にステータスが更新される**
    - **プロパティ20: ステータス更新時に処理情報が記録される**
    - **プロパティ22: 処理済み申請のステータス変更は拒否される**
    - **検証: 要件 5.1, 5.2, 5.3, 5.5**

- [ ] 6. 締切日管理機能の実装
  - [x] 6.1 締切日設定機能を実装
    - デフォルト値設定（10日）
    - 締切日取得
    - 締切日更新
    - 変更履歴記録
    - _要件: 2.1, 2.2, 2.3, 2.4_
  
  - [x] 6.2 締切日管理のプロパティテストを作成

    - **プロパティ6: 締切日変更は保存される**
    - **プロパティ7: 締切日変更履歴が記録される**
    - **検証: 要件 2.3, 2.4**

- [x] 7. チェックポイント - 申請管理機能の確認
  - 全てのテストが通ることを確認し、質問があればユーザーに確認する

- [ ] 8. シフト管理サービスの実装
  - [x] 8.1 シフト取得・表示機能を実装
    - 月別取得
    - 日付範囲フィルタ
    - 承認済みNG日の取得
    - _要件: 6.1, 6.2, 6.4_
  
  - [x] 8.2 シフト取得のプロパティテストを作成

    - **プロパティ23: シフト表示には必須情報が含まれる**
    - **プロパティ24: 日付範囲でシフトがフィルタされる**
    - **検証: 要件 6.2, 6.4**
  
  - [x] 8.3 シフト編集機能を実装
    - 従業員の追加・削除
    - 変更履歴記録
    - NG日警告チェック
    - _要件: 7.1, 7.2, 7.3_
  
  - [x] 8.4 シフト編集のプロパティテストを作成

    - **プロパティ25: シフトの従業員追加・削除が可能**
    - **プロパティ26: シフト更新時に変更履歴が記録される**
    - **プロパティ27: NG日がある従業員の割り当て時に警告が表示される**
    - **検証: 要件 7.1, 7.2, 7.3**

- [ ] 9. 通知サービスの実装
  - [x] 9.1 LINE通知機能を実装
    - LINE Messaging API統合
    - メッセージ送信
    - エラーハンドリング（リトライ、キューイング）
    - _要件: 1.6, 5.4, 7.4_
  
  - [x] 9.2 通知サービスのプロパティテストを作成

    - **プロパティ5: 申請作成時に確認通知が送信される**
    - **プロパティ21: ステータス更新時に通知が送信される**
    - **プロパティ28: シフト確定時に通知が送信される**
    - **検証: 要件 1.6, 5.4, 7.4**

- [x] 10. LINEボットインターフェースの実装
  - [x] 10.1 Webhookハンドラーを実装
    - LINE Webhook検証
    - イベントタイプ別の処理分岐
    - _要件: 1.1_
  
  - [x] 10.2 カレンダーUI生成機能を実装
    - Flex Messageでカレンダー表示
    - 翌月の日付のみ選択可能
    - 既申請日の無効化
    - _要件: 1.1, 1.2_
  
  - [x] 10.3 カレンダー生成のプロパティテストを作成

    - **プロパティ1: カレンダーは翌月の日付のみを含む**
    - **検証: 要件 1.2**
  
  - [x] 10.4 申請一覧表示機能を実装
    - Flex Messageで一覧表示
    - ステータス別の色分け
    - _要件: 3.1, 3.2, 3.3_
  
  - [x] 10.5 Rich Menuを設定
    - 申請ボタン
    - 一覧表示ボタン
    - _要件: 1.1, 3.1_

- [ ] 11. リマインダースケジューラーの実装
  - [x] 11.1 リマインダーチェック機能を実装
    - 締切日までの残り日数計算
    - 未申請者の抽出
    - 7日前、3日前、1日前の判定
    - _要件: 10.1, 10.2, 10.3, 10.5_
  
  - [x] 11.2 リマインダー送信機能を実装
    - LINE通知送信
    - 締切日と残り日数を含める
    - 送信履歴記録
    - _要件: 10.4, 10.6_
  
  - [x] 11.3 リマインダーのプロパティテストを作成

    - **プロパティ32: リマインダーは未申請者にのみ送信される**
    - **プロパティ33: リマインダーには必須情報が含まれる**
    - **プロパティ34: リマインダー送信履歴が記録される**
    - **検証: 要件 10.1, 10.2, 10.3, 10.4, 10.5, 10.6**
  
  - [x] 11.4 スケジューラーを設定
    - Cronジョブまたはタスクスケジューラー
    - 毎日実行
    - _要件: 10.1, 10.2, 10.3_

- [x] 12. チェックポイント - バックエンド機能の確認
  - 全てのテストが通ることを確認し、質問があればユーザーに確認する

- [ ] 13. Web管理画面の実装
  - [x] 13.1 管理者ログイン画面を実装
    - ログインフォーム
    - 認証処理
    - セッション管理
    - _要件: 8.2_
  
  - [x] 13.2 申請管理画面を実装
    - 申請一覧表示
    - 検索・フィルター機能
    - 承認・却下ボタン
    - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2_
  
  - [x] 13.3 シフト管理画面を実装
    - カレンダー表示
    - シフト編集機能
    - NG日警告表示
    - _要件: 6.1, 6.2, 6.3, 7.1, 7.3_
  
  - [x] 13.4 設定画面を実装
    - 締切日設定
    - 設定変更履歴表示
    - _要件: 2.2, 2.3, 2.4_

- [ ] 14. エラーハンドリングの実装
  - [x] 14.1 バリデーションエラーハンドリング
    - エラーメッセージ生成
    - ユーザーフレンドリーなメッセージ
    - _要件: 1.4, 2.6_
  
  - [x] 14.2 エラーハンドリングのユニットテストを作成

    - 無効な日付
    - 重複申請
    - 締切日超過
    - データベースエラー
    - _要件: 1.4, 2.5, 2.6, 9.4_
  
  - [x] 14.3 外部サービスエラーハンドリング
    - LINE APIエラー
    - リトライロジック
    - フォールバック処理
    - _要件: 1.6, 5.4, 7.4_

- [ ] 15. 統合とデプロイ準備
  - [x] 15.1 環境設定ファイルを作成
    - 本番環境用設定
    - 開発環境用設定
    - 環境変数ドキュメント
  
  - [x] 15.2 統合テストを作成

    - エンドツーエンドの申請フロー
    - LINEボットのWebhook処理
    - 管理画面の認証フロー
  
  - [x] 15.3 READMEとドキュメントを作成
    - セットアップ手順
    - 環境変数の説明
    - API仕様
    - デプロイ手順

- [x] 16. 最終チェックポイント
  - 全てのテストが通ることを確認し、システムが要件を満たしていることを確認する

## 注意事項

- `*`マークのタスクはオプションで、コア機能の実装を優先する場合はスキップ可能です
- 各タスクは前のタスクに基づいて構築されます
- チェックポイントで段階的に検証を行います
- プロパティテストは最低100回の反復実行を設定します
- 各プロパティテストには設計書のプロパティ番号をタグ付けします

# 設計書

## 概要

シフト申請管理システムは、従業員がLINEアプリを通じて翌月のNG日（勤務不可能な日）を申請し、管理者がWebインターフェースでそれを確認・承認してシフトを調整するアプリケーションです。

システムは以下の主要コンポーネントで構成されます：
- **LINEボット**: 従業員向けのインターフェース
- **Web管理画面**: 管理者向けのインターフェース
- **バックエンドAPI**: ビジネスロジックとデータ管理
- **データベース**: 申請、シフト、ユーザー情報の永続化
- **スケジューラー**: リマインダー通知の定期実行

## アーキテクチャ

システムは3層アーキテクチャを採用します：

```
┌─────────────────────────────────────────────────────────┐
│                    プレゼンテーション層                    │
├──────────────────────┬──────────────────────────────────┤
│   LINEボット          │   Web管理画面                     │
│   (従業員用)          │   (管理者用)                      │
└──────────────────────┴──────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────┐
│                    アプリケーション層                      │
├─────────────────────────────────────────────────────────┤
│  - 申請管理サービス                                       │
│  - シフト管理サービス                                     │
│  - 通知サービス                                          │
│  - 認証サービス                                          │
│  - リマインダースケジューラー                             │
└─────────────────────────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────┐
│                      データ層                            │
├─────────────────────────────────────────────────────────┤
│  - ユーザーテーブル                                       │
│  - 申請テーブル                                          │
│  - シフトテーブル                                        │
│  - 設定テーブル                                          │
│  - リマインダー履歴テーブル                               │
└─────────────────────────────────────────────────────────┘
```

### 技術スタック

- **バックエンド**: FastAPI 0.104+
- **ORM**: SQLAlchemy 2.0
- **データベース**: MySQL 8.0+
- **データベースドライバー**: PyMySQL または mysqlclient
- **バリデーション**: Pydantic v2
- **マイグレーション**: Alembic
- **LINEボット**: LINE Messaging API (line-bot-sdk)
- **スケジューラー**: APScheduler
- **認証**: FastAPI Security（セッションベース認証 - 管理者）、LINE ID（従業員）
- **テストフレームワーク**: pytest
- **プロパティベーステスト**: Hypothesis
- **非同期処理**: asyncio（FastAPI標準）

## コンポーネントとインターフェース

### 1. LINEボット（従業員インターフェース）

従業員がNG日を申請するためのLINEボットインターフェース。

**主要機能**:
- カレンダー表示と日付選択
- 申請一覧表示
- リマインダー通知受信

**LINE Messaging APIの使用**:
- **Webhook**: LINEからのメッセージを受信
- **Flex Message**: カレンダーUIの表示
- **Push Message**: リマインダーや承認通知の送信
- **Rich Menu**: メニューボタン（申請、一覧表示）

**インターフェース**:
```
handleLineWebhook(event: LineEvent): Response
  - メッセージタイプに応じて処理を分岐
  - テキストメッセージ、ポストバックイベントを処理

showCalendar(userId: string): FlexMessage
  - 翌月のカレンダーを生成
  - 既に申請済みの日付を無効化

submitRequest(userId: string, date: Date): Response
  - NG日申請を作成
  - 確認メッセージを返信

showRequestList(userId: string): FlexMessage
  - ユーザーの申請一覧を表示
  - ステータスごとに色分け
```

### 2. Web管理画面（管理者インターフェース）

管理者が申請を確認・承認し、シフトを調整するためのWebアプリケーション。

**主要機能**:
- 申請一覧表示とフィルタリング
- 申請の承認・却下
- シフトカレンダー表示
- シフト編集
- 締切日設定

**画面構成**:
- ログイン画面
- ダッシュボード（申請サマリー）
- 申請管理画面
- シフト管理画面
- 設定画面

**インターフェース**:
```
GET /admin/login
  - 管理者ログイン画面

POST /admin/login
  - 認証処理

GET /admin/requests
  - 申請一覧取得（フィルタ、検索対応）

POST /admin/requests/:id/approve
  - 申請承認

POST /admin/requests/:id/reject
  - 申請却下

GET /admin/shifts
  - シフト一覧取得（月指定）

PUT /admin/shifts/:date
  - シフト更新

GET /admin/settings
  - 設定取得

PUT /admin/settings/deadline
  - 締切日更新
```

### 3. バックエンドAPI

ビジネスロジックとデータ管理を担当。

**サービス層**:

#### 申請管理サービス
```
createRequest(workerId: string, date: Date): Request
  - 新規申請を作成
  - バリデーション（翌月チェック、重複チェック、締切日チェック）
  - データベースに保存
  - 管理者に通知

getRequestsByWorker(workerId: string): Request[]
  - 従業員の申請一覧を取得

getRequestsByStatus(status: RequestStatus): Request[]
  - ステータス別の申請一覧を取得

approveRequest(requestId: string, adminId: string): Request
  - 申請を承認
  - ステータス更新
  - 従業員に通知

rejectRequest(requestId: string, adminId: string): Request
  - 申請を却下
  - ステータス更新
  - 従業員に通知
```

#### シフト管理サービス
```
getShiftsByMonth(year: number, month: number): Shift[]
  - 指定月のシフト一覧を取得

updateShift(date: Date, workerIds: string[]): Shift
  - シフトを更新
  - NG日チェック（警告表示）
  - 従業員に通知

getApprovedNGDays(month: number): Map<Date, string[]>
  - 承認済みNG日の一覧を取得
```

#### 通知サービス
```
sendLineMessage(userId: string, message: string): void
  - LINEメッセージを送信

sendReminderToWorker(workerId: string, daysUntilDeadline: number): void
  - リマインダー通知を送信

sendApprovalNotification(workerId: string, request: Request): void
  - 承認通知を送信

sendRejectionNotification(workerId: string, request: Request): void
  - 却下通知を送信
```

#### 認証サービス
```
authenticateAdmin(username: string, password: string): Admin | null
  - 管理者認証

getWorkerByLineId(lineId: string): Worker | null
  - LINE IDから従業員を取得

registerWorker(lineId: string, name: string): Worker
  - 新規従業員登録
```

#### リマインダースケジューラー
```
checkAndSendReminders(): void
  - 毎日実行
  - 締切日までの残り日数を計算
  - 7日前、3日前、1日前の場合、未申請者にリマインダー送信
```

### 4. データベーススキーマ

#### ユーザーテーブル (users)
```
id: string (PK)
line_id: string (UNIQUE)
name: string
role: enum('worker', 'admin')
created_at: timestamp
updated_at: timestamp
```

#### 申請テーブル (requests)
```
id: string (PK)
worker_id: string (FK -> users.id)
request_date: date
status: enum('pending', 'approved', 'rejected')
created_at: timestamp
processed_at: timestamp (nullable)
processed_by: string (FK -> users.id, nullable)
```

#### シフトテーブル (shifts)
```
id: string (PK)
shift_date: date
worker_id: string (FK -> users.id)
created_at: timestamp
updated_at: timestamp
updated_by: string (FK -> users.id)

UNIQUE(shift_date, worker_id)
```

#### 設定テーブル (settings)
```
id: string (PK)
key: string (UNIQUE)
value: string
updated_at: timestamp
updated_by: string (FK -> users.id)
```

#### リマインダー履歴テーブル (reminder_logs)
```
id: string (PK)
worker_id: string (FK -> users.id)
sent_at: timestamp
days_before_deadline: integer
target_month: integer
target_year: integer
```

## データモデル

### Request（申請）
```
{
  id: string
  workerId: string
  requestDate: Date
  status: 'pending' | 'approved' | 'rejected'
  createdAt: Date
  processedAt: Date | null
  processedBy: string | null
}
```

### Shift（シフト）
```
{
  id: string
  shiftDate: Date
  workerId: string
  createdAt: Date
  updatedAt: Date
  updatedBy: string
}
```

### User（ユーザー）
```
{
  id: string
  lineId: string
  name: string
  role: 'worker' | 'admin'
  createdAt: Date
  updatedAt: Date
}
```

### Settings（設定）
```
{
  id: string
  key: string
  value: string
  updatedAt: Date
  updatedBy: string
}
```

### ReminderLog（リマインダー履歴）
```
{
  id: string
  workerId: string
  sentAt: Date
  daysBeforeDeadline: number
  targetMonth: number
  targetYear: number
}
```


## 正確性プロパティ

プロパティとは、システムの全ての有効な実行において真であるべき特性や動作のことです。これらは人間が読める仕様と機械で検証可能な正確性保証の橋渡しとなります。

### プロパティ1: カレンダーは翌月の日付のみを含む
*任意の*現在日付に対して、生成されるカレンダーは翌月の日付のみを含み、当月や翌々月の日付を含まない
**検証: 要件 1.2**

### プロパティ2: 申請作成時のステータスは保留中
*任意の*有効な日付と従業員IDに対して、新規申請を作成すると、そのステータスは「pending」に設定される
**検証: 要件 1.3**

### プロパティ3: 重複申請は拒否される
*任意の*申請に対して、同じ従業員が同じ日付で再度申請しようとすると、システムは申請を拒否する
**検証: 要件 1.4**

### プロパティ4: 申請には必須フィールドが記録される
*任意の*申請作成に対して、申請者ID、日付、作成日時が記録される
**検証: 要件 1.5**

### プロパティ5: 申請作成時に確認通知が送信される
*任意の*申請作成に対して、LINEで確認メッセージが送信される
**検証: 要件 1.6**

### プロパティ6: 締切日変更は保存される
*任意の*有効な締切日（1-31日）に対して、管理者が変更すると、新しい締切日が正しく保存される
**検証: 要件 2.3**

### プロパティ7: 締切日変更履歴が記録される
*任意の*締切日変更に対して、変更日時と変更者が記録される
**検証: 要件 2.4**

### プロパティ8: 締切日を過ぎた申請は拒否される
*任意の*現在日付と締切日の組み合わせに対して、現在日が締切日を過ぎている場合、新規申請は拒否される
**検証: 要件 2.5**

### プロパティ9: 締切日超過時にエラーメッセージが返される
*任意の*締切日を過ぎた申請試行に対して、締切日を過ぎたことを示すエラーメッセージが返される
**検証: 要件 2.6**

### プロパティ10: 申請一覧は従業員でフィルタされる
*任意の*従業員と申請セットに対して、申請一覧取得時にはその従業員の申請のみが返される
**検証: 要件 3.1**

### プロパティ11: 申請表示には必須フィールドが含まれる
*任意の*申請に対して、表示時には日付、ステータス、申請日時が含まれる
**検証: 要件 3.2**

### プロパティ12: 申請一覧は日付順にソートされる
*任意の*申請リストに対して、表示時には日付の新しい順（降順）にソートされる
**検証: 要件 3.3**

### プロパティ13: 管理者は全申請を取得できる
*任意の*申請セットに対して、管理者が申請一覧を取得すると、全ての従業員の申請が返される
**検証: 要件 4.1**

### プロパティ14: 管理者向け申請表示には必須フィールドが含まれる
*任意の*申請に対して、管理者向け表示時には従業員名、日付、ステータスが含まれる
**検証: 要件 4.2**

### プロパティ15: 保留中の申請が優先表示される
*任意の*申請リストに対して、表示時にはステータスが「pending」の申請が他のステータスより先に表示される
**検証: 要件 4.3**

### プロパティ16: 検索条件に一致する申請のみが返される
*任意の*検索クエリ（従業員名または日付）に対して、条件に一致する申請のみが返される
**検証: 要件 4.4**

### プロパティ17: フィルター条件に一致する申請のみが返される
*任意の*フィルター条件（ステータスまたは月）に対して、条件に一致する申請のみが返される
**検証: 要件 4.5**

### プロパティ18: 承認時にステータスが更新される
*任意の*「pending」状態の申請に対して、承認すると、ステータスが「approved」に更新される
**検証: 要件 5.1**

### プロパティ19: 却下時にステータスが更新される
*任意の*「pending」状態の申請に対して、却下すると、ステータスが「rejected」に更新される
**検証: 要件 5.2**

### プロパティ20: ステータス更新時に処理情報が記録される
*任意の*申請ステータス更新に対して、処理日時と処理者IDが記録される
**検証: 要件 5.3**

### プロパティ21: ステータス更新時に通知が送信される
*任意の*申請ステータス更新に対して、従業員にLINE通知が送信される
**検証: 要件 5.4**

### プロパティ22: 処理済み申請のステータス変更は拒否される
*任意の*「approved」または「rejected」状態の申請に対して、ステータス変更を試みると、システムは変更を拒否する
**検証: 要件 5.5**

### プロパティ23: シフト表示には必須情報が含まれる
*任意の*シフトデータに対して、表示時には各日の勤務予定者と承認済みNG日が含まれる
**検証: 要件 6.2**

### プロパティ24: 日付範囲でシフトがフィルタされる
*任意の*日付範囲に対して、その範囲内のシフトのみが返される
**検証: 要件 6.4**

### プロパティ25: シフトの従業員追加・削除が可能
*任意の*シフトに対して、従業員の追加と削除ができる
**検証: 要件 7.1**

### プロパティ26: シフト更新時に変更履歴が記録される
*任意の*シフト更新に対して、変更内容、更新日時、更新者が記録される
**検証: 要件 7.2**

### プロパティ27: NG日がある従業員の割り当て時に警告が表示される
*任意の*シフト割り当てに対して、その日に承認済みNG日がある従業員を割り当てようとすると、警告が返される
**検証: 要件 7.3**

### プロパティ28: シフト確定時に通知が送信される
*任意の*シフト確定に対して、影響を受ける従業員にLINE通知が送信される
**検証: 要件 7.4**

### プロパティ29: LINE IDで従業員が識別される
*任意の*LINE IDに対して、システムは正しく従業員を識別する
**検証: 要件 8.1**

### プロパティ30: 管理者権限が確認される
*任意の*管理者ユーザーに対して、ログイン時に管理者権限が確認される
**検証: 要件 8.3**

### プロパティ31: データ永続化のラウンドトリップ
*任意の*エンティティ（申請、シフト、ユーザー情報）に対して、データベースに保存した後に取得すると、同等のデータが返される
**検証: 要件 9.1, 9.2, 9.3**

### プロパティ32: リマインダーは未申請者にのみ送信される
*任意の*従業員セットと日付に対して、締切日の7日前、3日前、または1日前に、翌月の申請を提出していない従業員にのみリマインダーが送信される
**検証: 要件 10.1, 10.2, 10.3, 10.5**

### プロパティ33: リマインダーには必須情報が含まれる
*任意の*リマインダーに対して、締切日と残り日数が含まれる
**検証: 要件 10.4**

### プロパティ34: リマインダー送信履歴が記録される
*任意の*リマインダー送信に対して、送信日時、対象従業員、残り日数、対象月が記録される
**検証: 要件 10.6**

## エラーハンドリング

### エラーの種類

1. **バリデーションエラー**
   - 無効な日付（過去の日付、翌月以外）
   - 重複申請
   - 締切日超過
   - 必須フィールドの欠落

2. **認証・認可エラー**
   - 未認証アクセス
   - 権限不足
   - 無効なLINE ID

3. **データベースエラー**
   - 接続エラー
   - 書き込みエラー
   - トランザクションエラー

4. **外部サービスエラー**
   - LINE API通信エラー
   - タイムアウト

### エラーハンドリング戦略

**バリデーションエラー**:
- ユーザーに分かりやすいエラーメッセージを返す
- 入力値を保持して再入力の手間を減らす
- エラーログに記録

**認証・認可エラー**:
- 適切なHTTPステータスコード（401, 403）を返す
- ログイン画面にリダイレクト
- セキュリティログに記録

**データベースエラー**:
- トランザクションをロールバック
- ユーザーに一般的なエラーメッセージを表示
- 詳細なエラーログを記録
- 必要に応じてリトライ

**外部サービスエラー**:
- 指数バックオフでリトライ（最大3回）
- タイムアウト設定（10秒）
- フォールバック処理（通知失敗時はキューに保存）
- エラーログに記録

### エラーレスポンス形式

```
{
  success: false,
  error: {
    code: string,
    message: string,
    details: object (optional)
  }
}
```

## テスト戦略

### テストアプローチ

システムの正確性を保証するために、ユニットテストとプロパティベーステストの両方を使用します。

**ユニットテスト**:
- 特定の例やエッジケースを検証
- 統合ポイントのテスト
- エラー条件のテスト

**プロパティベーステスト**:
- 普遍的なプロパティを検証
- ランダム化による包括的な入力カバレッジ
- 各プロパティは設計書のプロパティを参照

### プロパティベーステストの設定

**テストライブラリ**: Hypothesis（Python用プロパティベーステストライブラリ）

**テスト設定**:
- 最低100回の反復実行（ランダム化のため）
- 各テストには設計書のプロパティ番号をタグ付け
- タグ形式: `Feature: shift-request-management, Property N: [プロパティ名]`
- pytestマーカーを使用してプロパティテストを識別

### テスト範囲

**申請管理**:
- プロパティ2-11: 申請作成、取得、フィルタリング
- ユニットテスト: 重複申請、締切日超過、無効な日付

**シフト管理**:
- プロパティ23-28: シフト表示、更新、通知
- ユニットテスト: NG日警告、シフト競合

**認証**:
- プロパティ29-30: LINE ID識別、管理者権限
- ユニットテスト: 未認証アクセス、権限不足

**データ永続化**:
- プロパティ31: ラウンドトリップ
- ユニットテスト: データベースエラー、トランザクションロールバック

**リマインダー**:
- プロパティ32-34: リマインダー送信、履歴記録
- ユニットテスト: 日付計算、未申請者フィルタリング

### 統合テスト

- LINEボットのWebhook処理
- 管理画面の認証フロー
- エンドツーエンドの申請フロー（作成→承認→通知）
- スケジューラーの実行

### テストデータ生成

プロパティベーステストでは、以下のジェネレーターを使用：
- ランダムな日付（過去、現在、未来）
- ランダムな従業員ID
- ランダムな申請ステータス
- ランダムなシフトデータ
- エッジケース（境界値、空リスト、null値）
